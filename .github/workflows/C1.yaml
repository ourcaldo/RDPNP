# MAIN Ubuntu Workflow
#
# Description:
# This workflow automates the setup of an Ubuntu SSH server
# using ngrok with a reserved domain.
#
# Author: ourcaldo@gmail.com
#
# Version: 1.1
# Date: 2025-09-21

name: Main Ubuntu

on:
  workflow_dispatch:
  repository_dispatch:
    types: [Main Ubuntu]

jobs:
  build:
    if: github.event_name == 'repository_dispatch' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
    - name: Update & Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y openssh-server curl unzip
        sudo systemctl enable ssh
        sudo systemctl start ssh

    - name: Setup SSH user
      run: |
        # Set password for default GitHub runner user
        echo "runner:P@ssw0rd!" | sudo chpasswd

        # (Optional) Enable root login too
        echo "root:RootPass123!" | sudo chpasswd
        sudo sed -i 's/^#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
        sudo sed -i 's/^PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo systemctl restart ssh

    - name: Download ngrok
      run: |
        curl -sSL https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz -o ngrok.tgz
        tar -xvzf ngrok.tgz
        sudo mv ngrok /usr/local/bin/

    - name: Create ngrok config file
      run: |
        mkdir -p ~/.ngrok2
        echo "version: 2" > ~/.ngrok2/ngrok.yml
        echo "authtoken: $NGROK_AUTH_TOKEN" >> ~/.ngrok2/ngrok.yml
        echo "tunnels:" >> ~/.ngrok2/ngrok.yml
        echo "  ssh:" >> ~/.ngrok2/ngrok.yml
        echo "    proto: tcp" >> ~/.ngrok2/ngrok.yml
        echo "    addr: 22" >> ~/.ngrok2/ngrok.yml
        echo "    hostname: lashonda-nonlaminated-jocelynn.ngrok-free.app" >> ~/.ngrok2/ngrok.yml
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Start ngrok Tunnel
      run: |
        nohup ngrok start --all --config ~/.ngrok2/ngrok.yml > ngrok.log 2>&1 &
        sleep 10
        curl --silent --show-error http://127.0.0.1:4040/api/tunnels || true

    - name: Check public IP
      run: curl http://ipinfo.io

    - name: Wait before next redeploy (5h30m)
      run: sleep 19800

    - name: Mark workflow as successful
      run: echo "Success!"

    - name: Re-dispatch workflow
      run: |
        curl -X POST \
          -H "Authorization: token ${{ secrets.PERSONAL_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          -d '{"event_type": "Main Ubuntu"}' \
          https://api.github.com/repos/${{ github.repository }}/dispatches
