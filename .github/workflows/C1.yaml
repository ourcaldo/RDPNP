name: Ubuntu Server with Ngrok

on:
  workflow_dispatch:
  repository_dispatch:
    types: [ubuntu-server]

jobs:
  ubuntu-server:
    if: github.event_name == 'repository_dispatch' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install ngrok
      run: |
        curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        sudo apt update && sudo apt install ngrok

    - name: Configure ngrok
      run: |
        mkdir -p ~/.ngrok2/
        echo "version: 2" > ~/.ngrok2/ngrok.yml
        echo "authtoken: ${{ secrets.NGROK_AUTH_TOKEN }}" >> ~/.ngrok2/ngrok.yml
        echo "tunnels:" >> ~/.ngrok2/ngrok.yml
        echo "  ssh:" >> ~/.ngrok2/ngrok.yml
        echo "    proto: tcp" >> ~/.ngrok2/ngrok.yml
        echo "    addr: 22" >> ~/.ngrok2/ngrok.yml
        echo "  web:" >> ~/.ngrok2/ngrok.yml
        echo "    proto: http" >> ~/.ngrok2/ngrok.yml
        echo "    addr: 80" >> ~/.ngrok2/ngrok.yml
        echo "    hostname: ${{ secrets.NGROK_DOMAIN }}" >> ~/.ngrok2/ngrok.yml

    - name: Set up SSH server
      run: |
        sudo apt update
        sudo apt install -y openssh-server
        sudo systemctl enable ssh
        sudo systemctl start ssh

    - name: Create user and set password
      run: |
        sudo useradd -m -s /bin/bash ubuntuuser
        echo "ubuntuuser:P@ssw0rd!" | sudo chpasswd
        echo "ubuntuuser ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/ubuntuuser

    - name: Install necessary packages
      run: |
        sudo apt install -y python3 python3-pip curl wget git vim

    - name: Configure SSH for password authentication
      run: |
        sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config
        sudo systemctl restart ssh

    - name: Start ngrok tunnels
      run: |
        ngrok start --all --config ~/.ngrok2/ngrok.yml > ngrok.log 2>&1 &
        sleep 10
        
        # Extract tunnel URLs
        curl http://localhost:4040/api/tunnels | jq -r '.tunnels[] | "\(.name): \(.public_url)"' > tunnel_urls.txt
        cat tunnel_urls.txt

    - name: Display connection information
      run: |
        echo "=== SSH Connection ==="
        cat tunnel_urls.txt | grep ssh
        echo ""
        echo "=== Web Server ==="
        cat tunnel_urls.txt | grep web
        echo ""
        echo "=== Login Credentials ==="
        echo "Username: ubuntuuser"
        echo "Password: P@ssw0rd!"

    - name: Start simple web server (optional)
      run: |
        python3 -m http.server 80 > /dev/null 2>&1 &

    - name: Keep alive and wait
      run: |
        echo "Server is running. Waiting for 5 hours 30 minutes..."
        sleep 19800

    - name: Re-dispatch workflow
      run: |
        curl -X POST \
          -H "Authorization: token ${{ secrets.PERSONAL_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          -d '{"event_type": "ubuntu-server"}' \
          https://api.github.com/repos/${{ github.repository }}/dispatches
