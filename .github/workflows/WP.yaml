name: WordPress with Ngrok (Ubuntu)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [WordPress]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
    # 1. Install dependencies
    - name: Install fucking requirements
      run: |
        sudo apt-get update
        sudo apt-get install -y apache2 php libapache2-mod-php php-mysql mysql-client unzip curl

    # 2. Setup WordPress
    - name: Install fucking WordPress
      run: |
        cd /var/www/html
        sudo rm -rf *
        sudo curl -O https://wordpress.org/latest.tar.gz
        sudo tar xzvf latest.tar.gz
        sudo mv wordpress/* .
        sudo rm -rf wordpress latest.tar.gz
        sudo mkdir -p wp-content/updraft
        sudo chown -R www-data:www-data /var/www/html

    # 3. Download ALL FUCKING BACKUPS
    - name: Download ALL FUCKING FILES TO wp-content/updraft
      run: |
        cd /var/www/html/wp-content/updraft
        sudo curl -O https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-plugins.zip
        sudo curl -O https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-plugins2.zip
        sudo curl -O https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-plugins3.zip
        sudo curl -O https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-plugins4.zip
        sudo curl -O https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-themes.zip
        sudo curl -O https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-uploads.zip
        sudo curl -O https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-uploads2.zip
        sudo curl -O https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-uploads3.zip
        sudo curl -O https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-uploads4.zip
        sudo curl -O https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-uploads5.zip
        sudo curl -O https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-uploads6.zip
        sudo curl -O https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-uploads7.zip
        sudo curl -O https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-uploads8.zip
        sudo curl -O https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-uploads9.zip
        sudo curl -O https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-uploads10.zip
        sudo curl -O https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-uploads11.zip
        sudo curl -O https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-uploads12.zip
        sudo curl -O https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-db.gz
        sudo chown -R www-data:www-data /var/www/html/wp-content/updraft

    # 4. Configure WordPress with SSL certificate
    - name: Configure fucking WordPress with SSL
      run: |
        sudo cp /var/www/html/wp-config-sample.php /var/www/html/wp-config.php
        sudo sed -i "s/database_name_here/defaultdb/g" /var/www/html/wp-config.php
        sudo sed -i "s/username_here/avnadmin/g" /var/www/html/wp-config.php
        sudo sed -i "s/password_here/AVNS_BTIvo47-3B9BKcAf2X7/g" /var/www/html/wp-config.php
        sudo sed -i "s/localhost/nexdb-nexus88.d.aivencloud.com:28185/g" /var/www/html/wp-config.php
        
        # Add the fucking SSL certificate properly
        echo -e "\n// SSL Configuration" | sudo tee -a /var/www/html/wp-config.php
        echo "define('MYSQL_CLIENT_FLAGS', MYSQLI_CLIENT_SSL);" | sudo tee -a /var/www/html/wp-config.php
        echo "\$ssl_cert = <<<EOD" | sudo tee -a /var/www/html/wp-config.php
        echo "-----BEGIN CERTIFICATE-----" | sudo tee -a /var/www/html/wp-config.php
        echo "MIIETTCCArWgAwIBAgIUeg0LxdwgQHAtwsh1ScEAP0G59VkwDQYJKoZIhvcNAQEM" | sudo tee -a /var/www/html/wp-config.php
        echo "BQAwQDE+MDwGA1UEAww1ZDRlMzMxMGEtOTIxYS00OTc5LWFlNzUtMDRkYjU2NDhl" | sudo tee -a /var/www/html/wp-config.php
        echo "MWUyIEdFTiAxIFByb2plY3QgQ0EwHhcNMjUwMjE5MjIwNjA0WhcNMzUwMjE3MjIw" | sudo tee -a /var/www/html/wp-config.php
        echo "NjA0WjBAMT4wPAYDVQQDDDVkNGUzMzEwYS05MjFhLTQ5NzktYWU3NS0wNGRiNTY0" | sudo tee -a /var/www/html/wp-config.php
        echo "OGUxZTIgR0VOIDEgUHJvamVjdCBDQTCCAaIwDQYJKoZIhvcNAQEBBQADggGPADCC" | sudo tee -a /var/www/html/wp-config.php
        echo "-----END CERTIFICATE-----" | sudo tee -a /var/www/html/wp-config.php
        echo "EOD;" | sudo tee -a /var/www/html/wp-config.php

    # 5. Install UpdraftPlus
    - name: Install fucking UpdraftPlus
      run: |
        sudo curl -o /var/www/html/wp-content/plugins/updraftplus.zip https://nexstorage.b-cdn.net/updraftplus-2.25.5.26.zip
        sudo unzip /var/www/html/wp-content/plugins/updraftplus.zip -d /var/www/html/wp-content/plugins/
        sudo rm /var/www/html/wp-content/plugins/updraftplus.zip
        sudo chown -R www-data:www-data /var/www/html/wp-content/plugins

    # 6. Setup ngrok with your domain
    - name: Configure fucking ngrok
      run: |
        curl -s https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz | sudo tar -xz -C /usr/local/bin
        echo "authtoken: ${{ secrets.NGROK_AUTH_TOKEN }}" > ~/.ngrok2/ngrok.yml
        echo "tunnels:" >> ~/.ngrok2/ngrok.yml
        echo "  wordpress:" >> ~/.ngrok2/ngrok.yml
        echo "    proto: http" >> ~/.ngrok2/ngrok.yml
        echo "    addr: 80" >> ~/.ngrok2/ngrok.yml
        echo "    hostname: hip-specially-escargot.ngrok-free.app" >> ~/.ngrok2/ngrok.yml
        nohup ngrok start --all > /dev/null 2>&1 &

    # 7. Keep the fucking instance running
    - name: Keep this shit alive
      run: sleep 30000
