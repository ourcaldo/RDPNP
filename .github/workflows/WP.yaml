name: WordPress with ngrok (Ubuntu)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [WordPress Setup]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
    - name: Install ngrok and dependencies
      run: |
        curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        sudo apt update
        sudo apt install -y ngrok jq

    - name: Configure ngrok with custom domain
      run: |
        mkdir -p ~/.config/ngrok/
        cat > ~/.config/ngrok/ngrok.yml <<EOL
        version: "2"
        authtoken: ${{ secrets.NGROK_AUTH_TOKEN }}
        tunnels:
          wordpress:
            proto: http
            addr: 80
            host_header: rewrite
            subdomain: hip-specially-escargot
        EOL

    - name: Install LAMP stack
      run: |
        sudo apt update
        sudo apt install -y apache2 mysql-server php libapache2-mod-php php-mysql php-curl php-gd php-mbstring php-xml php-xmlrpc php-soap php-intl php-zip
        sudo systemctl start apache2
        sudo systemctl start mysql
            
    - name: Configure MySQL Without Root Access
      run: |
        # Install MySQL without interactive prompts
        sudo debconf-set-selections <<< 'mysql-server mysql-server/root_password password temp_password'
        sudo debconf-set-selections <<< 'mysql-server mysql-server/root_password_again password temp_password'
        sudo apt-get install -y mysql-server
        
        # Create database and user directly during installation
        sudo mysql -e "CREATE DATABASE wordpress;"
        sudo mysql -e "CREATE USER 'wordpress'@'localhost' IDENTIFIED BY 'password';"
        sudo mysql -e "GRANT ALL PRIVILEGES ON wordpress.* TO 'wordpress'@'localhost';"
        sudo mysql -e "FLUSH PRIVILEGES;"
        
        # Remove root password (optional)
        sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH auth_socket;"
        - name: Download and setup WordPress
          run: |
            sudo rm -rf /var/www/html/*
            sudo wget https://wordpress.org/latest.tar.gz -O /var/www/latest.tar.gz
            sudo tar -xzvf /var/www/latest.tar.gz -C /var/www/html --strip-components=1
            sudo chown -R www-data:www-data /var/www/html
            sudo chmod -R 755 /var/www/html

    - name: Configure PHP settings
      run: |
        sudo sed -i 's/memory_limit = .*/memory_limit = 2048M/' /etc/php/*/apache2/php.ini
        sudo sed -i 's/upload_max_filesize = .*/upload_max_filesize = 2048M/' /etc/php/*/apache2/php.ini
        sudo sed -i 's/post_max_size = .*/post_max_size = 2048M/' /etc/php/*/apache2/php.ini
        sudo sed -i 's/max_execution_time = .*/max_execution_time = 300/' /etc/php/*/apache2/php.ini
        sudo systemctl restart apache2

    - name: Download and install UpdraftPlus
      run: |
        sudo mkdir -p /var/www/html/wp-content/updraft
        sudo wget https://nexstorage.b-cdn.net/updraftplus-2.25.5.26.zip -O /var/www/html/wp-content/plugins/updraftplus.zip
        sudo unzip /var/www/html/wp-content/plugins/updraftplus.zip -d /var/www/html/wp-content/plugins/
        sudo rm /var/www/html/wp-content/plugins/updraftplus.zip

    - name: Download backup files
      run: |
        cd /var/www/html/wp-content/updraft
        sudo wget https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-plugins.zip
        sudo wget https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-plugins2.zip
        sudo wget https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-plugins3.zip
        sudo wget https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-plugins4.zip
        sudo wget https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-themes.zip
        sudo wget https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-uploads.zip
        sudo wget https://nexstorage.b-cdn.net/backup_2025-05-09-2116_CETTA_30a1d6969066-db.gz

    - name: Start ngrok tunnel
      run: |
        ngrok start --all --config ~/.config/ngrok/ngrok.yml > /dev/null &
        sleep 10

    - name: Display Ngrok Public URL
      run: |
        curl -s http://localhost:4040/api/tunnels | jq '.tunnels[] | {name, public_url}'
        echo "WordPress should be available at:"
        curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[] | select(.name=="wordpress") | .public_url'

    - name: Wait before next redeploy (5h30m)
      run: sleep 19800

    - name: Re-dispatch workflow
      run: |
        curl -X POST \
          -H "Authorization: token ${{ secrets.PERSONAL_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          -d '{"event_type": "WordPress Setup"}' \
          https://api.github.com/repos/${{ github.repository }}/dispatches
